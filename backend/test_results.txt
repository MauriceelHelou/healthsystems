============================= test session starts =============================
platform win32 -- Python 3.14.0, pytest-9.0.1, pluggy-1.6.0 -- C:\Users\mauri\AppData\Local\Python\pythoncore-3.14-64\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\mauri\OneDrive - Harvard University\New folder (2)\healthsystems\backend
configfile: pytest.ini (WARNING: ignoring pytest config in pyproject.toml!)
plugins: anyio-4.11.0, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 22 items

tests/test_api_endpoints.py::TestCrisisEndpointsAPI::test_crisis_endpoints_returns_200 PASSED [  4%]
tests/test_api_endpoints.py::TestCrisisEndpointsAPI::test_crisis_endpoints_returns_array PASSED [  9%]
tests/test_api_endpoints.py::TestCrisisEndpointsAPI::test_crisis_endpoints_not_empty FAILED [ 13%]
tests/test_api_endpoints.py::TestCrisisEndpointsAPI::test_crisis_endpoint_structure PASSED [ 18%]
tests/test_api_endpoints.py::TestCrisisEndpointsAPI::test_crisis_endpoints_performance PASSED [ 22%]
tests/test_api_endpoints.py::TestCrisisSubgraphAPI::test_crisis_subgraph_requires_post PASSED [ 27%]
tests/test_api_endpoints.py::TestCrisisSubgraphAPI::test_crisis_subgraph_requires_crisis_ids PASSED [ 31%]
tests/test_api_endpoints.py::TestCrisisSubgraphAPI::test_crisis_subgraph_with_valid_input SKIPPED [ 36%]
tests/test_api_endpoints.py::TestCrisisSubgraphAPI::test_crisis_subgraph_response_structure SKIPPED [ 40%]
tests/test_api_endpoints.py::TestCrisisSubgraphAPI::test_crisis_subgraph_performance SKIPPED [ 45%]
tests/test_api_endpoints.py::TestPathwaysAPI::test_pathways_returns_200 PASSED [ 50%]
tests/test_api_endpoints.py::TestPathwaysAPI::test_pathways_returns_array PASSED [ 54%]
tests/test_api_endpoints.py::TestPathwaysAPI::test_pathways_accepts_limit PASSED [ 59%]
tests/test_api_endpoints.py::TestPathwaysAPI::test_pathways_performance PASSED [ 63%]
tests/test_api_endpoints.py::TestPathwaysAPI::test_pathways_with_filters PASSED [ 68%]
tests/test_api_endpoints.py::TestPathwaysAPI::test_pathway_structure_if_exists PASSED [ 72%]
tests/test_api_endpoints.py::TestMechanismsAPIPerformance::test_mechanisms_returns_200 PASSED [ 77%]
tests/test_api_endpoints.py::TestMechanismsAPIPerformance::test_mechanisms_performance PASSED [ 81%]
tests/test_api_endpoints.py::TestMechanismsAPIPerformance::test_mechanisms_returns_node_names PASSED [ 86%]
tests/test_api_endpoints.py::TestPathfindingAPI::test_pathfinding_requires_post PASSED [ 90%]
tests/test_api_endpoints.py::TestPathfindingAPI::test_pathfinding_with_valid_nodes SKIPPED [ 95%]
tests/test_api_endpoints.py::TestPathfindingAPI::test_pathfinding_response_structure SKIPPED [100%]
ERROR: Coverage failure: total of 16 is less than fail-under=80


================================== FAILURES ===================================
___________ TestCrisisEndpointsAPI.test_crisis_endpoints_not_empty ____________
tests\test_api_endpoints.py:37: in test_crisis_endpoints_not_empty
    assert len(data) > 0, "No crisis endpoints found in database"
E   AssertionError: No crisis endpoints found in database
E   assert 0 > 0
E    +  where 0 = len([])
---------------------------- Captured stdout setup ----------------------------
2025-11-23 00:00:23,446 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-23 00:00:23,446 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("nodes")
2025-11-23 00:00:23,446 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-11-23 00:00:23,446 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("mechanisms")
2025-11-23 00:00:23,446 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-11-23 00:00:23,447 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("geographic_contexts")
2025-11-23 00:00:23,447 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-11-23 00:00:23,447 INFO sqlalchemy.engine.Engine COMMIT
---------------------------- Captured stderr setup ----------------------------
2025-11-23 00:00:23,446 - sqlalchemy.engine.Engine - INFO - BEGIN (implicit)
2025-11-23 00:00:23,446 - sqlalchemy.engine.Engine - INFO - PRAGMA main.table_info("nodes")
2025-11-23 00:00:23,446 - sqlalchemy.engine.Engine - INFO - [raw sql] ()
2025-11-23 00:00:23,446 - sqlalchemy.engine.Engine - INFO - PRAGMA main.table_info("mechanisms")
2025-11-23 00:00:23,446 - sqlalchemy.engine.Engine - INFO - [raw sql] ()
2025-11-23 00:00:23,447 - sqlalchemy.engine.Engine - INFO - PRAGMA main.table_info("geographic_contexts")
2025-11-23 00:00:23,447 - sqlalchemy.engine.Engine - INFO - [raw sql] ()
2025-11-23 00:00:23,447 - sqlalchemy.engine.Engine - INFO - COMMIT
----------------------------- Captured log setup ------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 PRAGMA main.table_info("nodes")
INFO     sqlalchemy.engine.Engine:base.py:1846 [raw sql] ()
INFO     sqlalchemy.engine.Engine:base.py:1846 PRAGMA main.table_info("mechanisms")
INFO     sqlalchemy.engine.Engine:base.py:1846 [raw sql] ()
INFO     sqlalchemy.engine.Engine:base.py:1846 PRAGMA main.table_info("geographic_contexts")
INFO     sqlalchemy.engine.Engine:base.py:1846 [raw sql] ()
INFO     sqlalchemy.engine.Engine:base.py:2708 COMMIT
---------------------------- Captured stdout call -----------------------------
2025-11-23 00:00:23,450 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-23 00:00:23,450 INFO sqlalchemy.engine.Engine SELECT nodes.id AS nodes_id, nodes.name AS nodes_name, nodes.node_type AS nodes_node_type, nodes.unit AS nodes_unit, nodes.measurement_method AS nodes_measurement_method, nodes.typical_range AS nodes_typical_range, nodes.data_sources AS nodes_data_sources, nodes.category AS nodes_category, nodes.description AS nodes_description, nodes.created_at AS nodes_created_at, nodes.updated_at AS nodes_updated_at 
FROM nodes
2025-11-23 00:00:23,450 INFO sqlalchemy.engine.Engine [cached since 0.07865s ago] ()
2025-11-23 00:00:23,451 INFO sqlalchemy.engine.Engine ROLLBACK
---------------------------- Captured stderr call -----------------------------
2025-11-23 00:00:23,449 - api.middleware.logging - INFO - Request: GET /api/nodes/crisis-endpoints from testclient
2025-11-23 00:00:23,450 - sqlalchemy.engine.Engine - INFO - BEGIN (implicit)
2025-11-23 00:00:23,450 - sqlalchemy.engine.Engine - INFO - SELECT nodes.id AS nodes_id, nodes.name AS nodes_name, nodes.node_type AS nodes_node_type, nodes.unit AS nodes_unit, nodes.measurement_method AS nodes_measurement_method, nodes.typical_range AS nodes_typical_range, nodes.data_sources AS nodes_data_sources, nodes.category AS nodes_category, nodes.description AS nodes_description, nodes.created_at AS nodes_created_at, nodes.updated_at AS nodes_updated_at 
FROM nodes
2025-11-23 00:00:23,450 - sqlalchemy.engine.Engine - INFO - [cached since 0.07865s ago] ()
2025-11-23 00:00:23,451 - api.middleware.logging - INFO - Response: 200 for GET /api/nodes/crisis-endpoints in 0.002s
2025-11-23 00:00:23,451 - sqlalchemy.engine.Engine - INFO - ROLLBACK
2025-11-23 00:00:23,452 - httpx - INFO - HTTP Request: GET http://testserver/api/nodes/crisis-endpoints "HTTP/1.1 200 OK"
------------------------------ Captured log call ------------------------------
INFO     api.middleware.logging:logging.py:31 Request: GET /api/nodes/crisis-endpoints from testclient
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT nodes.id AS nodes_id, nodes.name AS nodes_name, nodes.node_type AS nodes_node_type, nodes.unit AS nodes_unit, nodes.measurement_method AS nodes_measurement_method, nodes.typical_range AS nodes_typical_range, nodes.data_sources AS nodes_data_sources, nodes.category AS nodes_category, nodes.description AS nodes_description, nodes.created_at AS nodes_created_at, nodes.updated_at AS nodes_updated_at 
FROM nodes
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.07865s ago] ()
INFO     api.middleware.logging:logging.py:43 Response: 200 for GET /api/nodes/crisis-endpoints in 0.002s
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/nodes/crisis-endpoints "HTTP/1.1 200 OK"
-------------------------- Captured stdout teardown ---------------------------
2025-11-23 00:00:23,580 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-23 00:00:23,580 INFO sqlalchemy.engine.Engine DELETE FROM mechanisms
2025-11-23 00:00:23,580 INFO sqlalchemy.engine.Engine [cached since 0.1973s ago] ()
2025-11-23 00:00:23,582 INFO sqlalchemy.engine.Engine DELETE FROM nodes
2025-11-23 00:00:23,582 INFO sqlalchemy.engine.Engine [cached since 0.1978s ago] ()
2025-11-23 00:00:23,582 INFO sqlalchemy.engine.Engine DELETE FROM geographic_contexts
2025-11-23 00:00:23,582 INFO sqlalchemy.engine.Engine [cached since 0.1976s ago] ()
2025-11-23 00:00:23,582 INFO sqlalchemy.engine.Engine COMMIT
-------------------------- Captured stderr teardown ---------------------------
2025-11-23 00:00:23,580 - sqlalchemy.engine.Engine - INFO - BEGIN (implicit)
2025-11-23 00:00:23,580 - sqlalchemy.engine.Engine - INFO - DELETE FROM mechanisms
2025-11-23 00:00:23,580 - sqlalchemy.engine.Engine - INFO - [cached since 0.1973s ago] ()
2025-11-23 00:00:23,582 - sqlalchemy.engine.Engine - INFO - DELETE FROM nodes
2025-11-23 00:00:23,582 - sqlalchemy.engine.Engine - INFO - [cached since 0.1978s ago] ()
2025-11-23 00:00:23,582 - sqlalchemy.engine.Engine - INFO - DELETE FROM geographic_contexts
2025-11-23 00:00:23,582 - sqlalchemy.engine.Engine - INFO - [cached since 0.1976s ago] ()
2025-11-23 00:00:23,582 - sqlalchemy.engine.Engine - INFO - COMMIT
---------------------------- Captured log teardown ----------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 DELETE FROM mechanisms
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.1973s ago] ()
INFO     sqlalchemy.engine.Engine:base.py:1846 DELETE FROM nodes
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.1978s ago] ()
INFO     sqlalchemy.engine.Engine:base.py:1846 DELETE FROM geographic_contexts
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.1976s ago] ()
INFO     sqlalchemy.engine.Engine:base.py:2708 COMMIT
=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.14.0-final-0 _______________

Name                                       Stmts   Miss  Cover   Missing
------------------------------------------------------------------------
algorithms\__init__.py                         0      0   100%
algorithms\bayesian_weighting.py              99     99     0%   8-392
algorithms\functional_form_classifier.py     122    122     0%   18-467
api\__init__.py                                1      0   100%
api\config.py                                 50      0   100%
api\main.py                                   43     11    74%   33-42, 89, 105, 113-114
api\middleware\__init__.py                     0      0   100%
api\middleware\logging.py                     15      0   100%
api\middleware\rate_limit.py                  26      2    92%   42, 56
api\routes\__init__.py                         4      0   100%
api\routes\mechanisms.py                      84     49    42%   93, 95, 97, 99, 101, 135-140, 170-192, 215-300
api\routes\nodes.py                          338    242    28%   190-219, 238-253, 278-286, 291-301, 314-329, 359-516, 547-638, 660-662, 696-869, 900-936
api\routes\pathways.py                       150     95    37%   82-87, 92-97, 104, 117-143, 191-252, 286, 289-290, 308-375, 386-397
cli\__init__.py                                1      1     0%   6
cli\base.py                                   40     40     0%   5-75
cli\commands\__init__.py                       5      5     0%   5-10
cli\commands\classify.py                      71     71     0%   5-130
cli\commands\extract.py                       70     70     0%   5-131
cli\commands\regrade.py                       43     43     0%   5-78
cli\commands\validate.py                     103    103     0%   5-167
cli\main.py                                   37     37     0%   5-95
config\__init__.py                             4      4     0%   6-10
config\api.py                                 34     34     0%   4-65
config\database.py                            22     22     0%   4-50
config\llm.py                                 23     23     0%   4-46
core\__init__.py                               3      3     0%   4-7
core\mechanism_grading.py                     86     86     0%   4-190
core\node_classification.py                  110    110     0%   5-295
extraction\__init__.py                         5      5     0%   5-10
extraction\core.py                            63     63     0%   5-147
extraction\llm_client.py                      12     12     0%   5-45
extraction\progress.py                        35     35     0%   4-59
extraction\prompts.py                          3      3     0%   5-64
extraction\yaml_handler.py                    30     30     0%   5-91
models\__init__.py                             3      0   100%
models\database.py                            41     20    51%   31-39, 51-59, 64-69, 91-97
models\mechanism.py                           97      5    95%   53, 129, 133, 229, 233
pipelines\__init__.py                          0      0   100%
pipelines\cdc_wonder_api.py                  172    172     0%   22-448
pipelines\end_to_end_discovery.py            169    169     0%   13-428
pipelines\grey_literature_search.py           85     85     0%   16-343
pipelines\literature_search.py               203    203     0%   11-525
pipelines\llm_mechanism_discovery.py         249    249     0%   18-904
pipelines\mechanism_deduplication.py         199    199     0%   12-535
services\__init__.py                           0      0   100%
tests\__init__.py                              0      0   100%
tests\conftest.py                             39     10    74%   61-72, 78, 90
tests\test_api.py                             29     29     0%   5-45
tests\test_api_endpoints.py                  156     52    67%   45-50, 85-94, 104-118, 128-139, 183-189, 215-219, 239-251, 261-276, 280
tests\test_bayesian_weighting.py              49     49     0%   5-142
tests\test_mechanisms_api.py                 142    142     0%   7-418
verify_test_setup.py                          82     82     0%   12-138
------------------------------------------------------------------------
TOTAL                                       3447   2886    16%
Coverage HTML written to dir htmlcov
FAIL Required test coverage of 80% not reached. Total coverage: 16.28%
=========================== short test summary info ===========================
FAILED tests/test_api_endpoints.py::TestCrisisEndpointsAPI::test_crisis_endpoints_not_empty - AssertionError: No crisis endpoints found in database
assert 0 > 0
 +  where 0 = len([])
=================== 1 failed, 16 passed, 5 skipped in 2.31s ===================
